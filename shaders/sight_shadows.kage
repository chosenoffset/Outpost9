//kage:unit pixels

package main

// Player position in screen coordinates
var PlayerPos vec2

// Maximum distance to check for occlusion
var MaxDistance float

func Fragment(position vec4, texCoord vec2, color vec4) vec4 {
	// Get screen dimensions
	screenSize := imageDstTextureSize()

	// DEBUG: Test if PlayerPos uniform is being received at all
	// If PlayerPos.x > 0, show red in top-left corner
	if texCoord.x < 0.1 && texCoord.y < 0.1 {
		if PlayerPos.x > 0.0 {
			return vec4(1, 0, 0, 0.8) // Red = PlayerPos is received
		} else {
			return vec4(1, 1, 0, 0.8) // Yellow = PlayerPos is zero or not received
		}
	}

	// DEBUG: First check if current pixel is a wall (like the magenta test that worked)
	currentPixel := imageSrc0At(texCoord)
	if currentPixel.a > 0.1 {
		return vec4(0, 1, 0, 0.5) // Green overlay on walls
	}

	// Convert PlayerPos from pixel coordinates to texCoord space (0.0 to 1.0)
	playerTexCoord := PlayerPos / screenSize

	// DEBUG: Show where shader thinks player is (cyan dot at calculated position)
	pixelDiff := abs(texCoord - playerTexCoord)
	if pixelDiff.x < 0.05 && pixelDiff.y < 0.05 {
		return vec4(0, 1, 1, 1.0) // Cyan dot at playerTexCoord
	}

	// Calculate direction from player to current pixel (in texCoord space)
	direction := texCoord - playerTexCoord
	distance := length(direction)

	// DEBUG: Red circle around player to verify PlayerPos (make it HUGE to see if it exists at all)
	if distance < 0.3 { // 30% of screen in texCoord space
		return vec4(1, 0, 0, 0.3) // Red circle
	}

	// If we're at the player position, no shadow
	if distance < 0.001 {
		return vec4(0, 0, 0, 0) // Transparent
	}

	// Normalize direction
	direction = direction / distance

	// Raycast from player toward this pixel
	// Step size in texCoord space (small steps for accuracy)
	stepSize := 1.0 / screenSize.x // One pixel step in texCoord space

	// Kage requires constant loop bounds, so use fixed max iterations
	for i := 1; i < 2000; i++ {
		t := float(i) * stepSize

		// Stop if we've traveled the full distance to the pixel
		if t >= distance {
			break
		}

		// Sample position along ray (in texCoord space)
		sampleTexCoord := playerTexCoord + direction * t

		// Sample wall texture (same as magenta test)
		wallSample := imageSrc0At(sampleTexCoord)

		// If we hit a wall, this pixel is in shadow
		if wallSample.a > 0.1 {
			return vec4(0, 0, 1, 0.6) // Blue shadow (debug color)
		}
	}

	// No wall blocking - visible
	return vec4(0, 0, 0, 0) // Transparent
}
